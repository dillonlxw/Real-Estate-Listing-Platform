<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Properties</title>
  <link rel="stylesheet" th:href="@{/css/properties.css}" />
</head>
<body>
    <div class="decorative-box">
        <!-- Navigation Bar -->
        <nav>
            <div class="nav-left">
            <div class="logo">
                <span class="logo-circle"></span>
                <a th:href="@{/}" class="company-text-link">
                    <span class="company-text">Spring Real Estate</span>
                </a>
            </div>
            </div>
            <div class="nav-right">
            <ul class="nav-links">
                <li><a th:href="@{/}">Home</a></li>
                <li><a th:href="@{/properties}" class="active-link">Properties</a></li>
                <li><a th:href="@{/about}">About us</a></li>
            </ul>
            </div>
        </nav>

        <!-- Properties content -->
        <div class="page-container">
            <div class="properties-wrapper">
                <!-- Global Success/Error Messages -->
                <div th:if="${globalSuccessMessage}" class="alert alert-success" th:text="${globalSuccessMessage}"></div>
                <!-- ... (other messages if needed) ... -->

                <div class="properties-header">
                    <h1 th:text="${propertiesMessage}">Properties</h1>
                    <div class="action-buttons">
                        <!-- Sort Dropdown Button -->
                        <div class="dropdown">
                            <button class="action-button sort-button dropdown-toggle" onclick="toggleDropdown('sortDropdownContent')">
                                Sort <span class="dropdown-caret">▾</span>
                            </button>
                            <div id="sortDropdownContent" class="dropdown-content">
                                <a th:href="@{/properties(minPrice=${currentMinPrice != null ? #numbers.formatDecimal(currentMinPrice,1,2,'POINT') : ''}, maxPrice=${currentMaxPrice != null ? #numbers.formatDecimal(currentMaxPrice,1,2,'POINT') : ''}, status=${currentStatus}, sortOrder='price,asc')}"
                                   th:classappend="${currentSortOrder == 'price,asc' ? 'active-sort' : ''}">Price: Low to High</a>
                                <a th:href="@{/properties(minPrice=${currentMinPrice != null ? #numbers.formatDecimal(currentMinPrice,1,2,'POINT') : ''}, maxPrice=${currentMaxPrice != null ? #numbers.formatDecimal(currentMaxPrice,1,2,'POINT') : ''}, status=${currentStatus}, sortOrder='price,desc')}"
                                   th:classappend="${currentSortOrder == 'price,desc' ? 'active-sort' : ''}">Price: High to Low</a>
                            </div>
                        </div>
                        <a class="action-button select-button" onclick="showPopup('filterPopup')">Filter</a>
                        <!-- Filter Popup -->
                        <div id="filterPopup" class="popup" data-backdrop-close="true">
                            <div class="popup-content">
                                <span class="close-button" onclick="hidePopup('filterPopup')">×</span>
                                <h2>Filter Properties</h2>
                                <form th:action="@{/properties}" method="get" class="filter-form">
                                    <input type="hidden" name="sortOrder" th:value="${currentSortOrder}" />
                                    <div class="form-group">
                                        <label for="minPrice">Min Price: <span id="minPriceValue" th:text="${#numbers.formatCurrency(currentMinPrice)}">$0</span></label>
                                        <input type="range" id="minPrice" name="minPrice"
                                               th:min="0"
                                               th:max="${maxOverallPrice}"
                                               th:value="${currentMinPrice}"
                                               step="1000" class="price-slider">
                                    </div>
                                    <div class="form-group">
                                        <label for="maxPrice">Max Price: <span id="maxPriceValue" th:text="${#numbers.formatCurrency(currentMaxPrice)}">$5,000,000</span></label>
                                        <input type="range" id="maxPrice" name="maxPrice"
                                               th:min="0"
                                               th:max="${maxOverallPrice}"
                                               th:value="${currentMaxPrice}"
                                               step="1000" class="price-slider">
                                    </div>
                                    <div class="form-group">
                                        <label>Status:</label>
                                        <div class="status-filter-options">
                                            <div class="status-option">
                                                <input type="radio" id="statusAll" name="status" value="" th:checked="${currentStatus == ''}">
                                                <label for="statusAll">All</label>
                                            </div>
                                            <div class="status-option">
                                                <input type="radio" id="statusForSale" name="status" value="Sale" th:checked="${currentStatus == 'Sale'}">
                                                <label for="statusForSale">Sale</label>
                                            </div>
                                            <div class="status-option">
                                                <input type="radio" id="statusForRent" name="status" value="Rent" th:checked="${currentStatus == 'Rent'}">
                                                <label for="statusForRent">Rent</label>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="action-button apply-filter-button">Apply Filter</button>
                                </form>
                            </div>
                        </div>
                        <a class="action-button add-button" onclick="showPopup('addPropertyPopup')">Add Property</a>
                        <!-- Add Property Popup -->
                        <div id="addPropertyPopup" class="popup" data-backdrop-close="true">
                            <div class="popup-content">
                                <span class="close-button" onclick="hidePopup('addPropertyPopup')">×</span>
                                <h2>Add New Property</h2>
                                <form th:action="@{/properties/add}" th:object="${newProperty}" method="post" class="add-property-form">
                                    <div class="form-group">
                                        <label for="addPropertyName">Property Name:</label>
                                        <input type="text" id="addPropertyName" th:field="*{propertyName}" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="addAddress">Address:</label>
                                        <input type="text" id="addAddress" th:field="*{address}" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="addPrice">Price:</label>
                                        <input type="number" id="addPrice" th:field="*{price}" step="0.01" min="0" class="form-control" required />
                                    </div>
                                    <div class="form-group">
                                        <label for="addType">Type:</label>
                                        <input type="text" id="addType" th:field="*{type}" class="form-control" required placeholder="e.g., Apartment, House, Villa"/>
                                    </div>
                                    <div class="form-group">
                                        <label for="addStatus">Status:</label>
                                        <select id="addStatus" th:field="*{status}" class="form-control" required>
                                            <option value="">-- Select Status --</option>
                                            <option value="Sale">Sale</option>
                                            <option value="Rent">Rent</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="action-button apply-filter-button">Save Property</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="properties-table-container">
                    <table class="properties-table">
                        <thead>
                            <tr>
                                <th>Property Name</th>
                                <th>Address</th>
                                <th>Price</th>
                                <th>Type</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${properties.isEmpty()}">
                                <td colspan="5" style="text-align: center;">No properties available for the selected criteria.</td>
                            </tr>
                            <tr th:each="property : ${properties}"
                                th:data-property-id="${property.id}"
                                th:data-property-name="${property.propertyName}"
                                th:data-property-status="${property.status}"
                                th:classappend="(${property.status.equalsIgnoreCase('Rent')} or ${property.status.equalsIgnoreCase('Sale')}) ? 'clickable-property-row' : ''">
                                <td th:text="${property.propertyName}">Modern Apartment</td>
                                <td th:text="${property.address}">123 Main St, City</td>
                                <td th:text="${#numbers.formatCurrency(property.price)}">$350,000</td>
                                <td th:text="${property.type}">Apartment</td>
                                <td th:text="${property.status}">Sale</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="bg-image"></div>
        </div>

        <!-- Action Confirmation Popup -->
        <div id="actionConfirmPopup" class="popup" data-backdrop-close="false">
            <div class="popup-content popup-small">
                <h2 id="actionConfirmTitle">Confirm Action?</h2> <!-- Dynamic Title -->
                <p id="actionConfirmPropertyName" style="text-align: center; margin-bottom: 20px;"></p>
                <div class="popup-actions">
                    <button id="actionConfirmNoButton" class="popup-button button-no">No</button>
                    <button id="actionConfirmYesButton" class="popup-button button-yes">Yes</button>
                </div>
            </div>
        </div>

        <!-- Action Success Popup -->
        <div id="actionSuccessPopup" class="popup" data-backdrop-close="true">
            <div class="popup-content popup-small">
                <span class="close-button" onclick="hidePopupAndRefresh('actionSuccessPopup')">×</span> <!-- Modified onclick -->
                <h2 id="actionSuccessMessage">Action successful!</h2> <!-- Dynamic Message -->
            </div>
        </div>
    </div>

<script th:inline="javascript">
    const maxOverallPrice = /*[[${maxOverallPrice}]]*/ 5000000;
    let currentActionPropertyId = null;
    let currentActionPropertyStatus = ''; // To store 'Sale' or 'Rent' for dynamic messages

    function showPopup(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) {
            popup.style.display = "flex";
            document.body.style.overflow = 'hidden';
        }
    }

    function hidePopup(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) {
             popup.style.display = "none";
             // Only restore body scroll if no other popups are active
             const anyPopupActive = Array.from(document.querySelectorAll('.popup')).some(p => p.style.display === 'flex');
             if (!anyPopupActive) {
                document.body.style.overflow = 'auto';
             }

             if (popupId === 'addPropertyPopup') {
                const form = popup.querySelector('.add-property-form');
                if (form) form.reset();
             }
             if (popupId === 'actionConfirmPopup') {
                currentActionPropertyId = null;
                currentActionPropertyStatus = '';
                document.getElementById('actionConfirmPropertyName').textContent = '';
                const yesButton = document.getElementById('actionConfirmYesButton');
                const noButton = document.getElementById('actionConfirmNoButton');
                if(yesButton) yesButton.disabled = false;
                if(noButton) noButton.disabled = false;
             }
        }
    }

    // New function to hide a popup and then refresh the page
    function hidePopupAndRefresh(popupId) {
        hidePopup(popupId);
        window.location.reload(); // Reload the current page
    }


    const minPriceSlider = document.getElementById('minPrice');
    const maxPriceSlider = document.getElementById('maxPrice');
    const minPriceValueDisplay = document.getElementById('minPriceValue');
    const maxPriceValueDisplay = document.getElementById('maxPriceValue');
    const userLocale = document.documentElement.lang || navigator.language || 'en-US';
    const defaultCurrency = 'USD';
    const currencyFormatter = new Intl.NumberFormat(userLocale, {
        style: 'currency', currency: defaultCurrency, minimumFractionDigits: 0, maximumFractionDigits: 0
    });

    function updatePriceDisplay(value, displayElement) {
        if (displayElement) displayElement.textContent = currencyFormatter.format(value);
    }

    if (minPriceSlider && maxPriceSlider && minPriceValueDisplay && maxPriceValueDisplay) {
        updatePriceDisplay(minPriceSlider.value, minPriceValueDisplay);
        updatePriceDisplay(maxPriceSlider.value, maxPriceValueDisplay);
        minPriceSlider.addEventListener('input', function() {
            let minValue = parseFloat(this.value);
            let maxValue = parseFloat(maxPriceSlider.value);
            if (minValue > maxValue) {
                maxPriceSlider.value = minValue;
                updatePriceDisplay(minValue, maxPriceValueDisplay);
            }
            updatePriceDisplay(minValue, minPriceValueDisplay);
        });
        maxPriceSlider.addEventListener('input', function() {
            let maxValue = parseFloat(this.value);
            let minValue = parseFloat(minPriceSlider.value);
            if (maxValue < minValue) {
                minPriceSlider.value = maxValue;
                updatePriceDisplay(maxValue, minPriceValueDisplay);
            }
            updatePriceDisplay(maxValue, maxPriceValueDisplay);
        });
    }

    function toggleDropdown(dropdownId) {
        document.getElementById(dropdownId).classList.toggle("show-dropdown");
    }

    window.onclick = function(event) {
        // Close dropdown logic
        if (!event.target.matches('.dropdown-toggle') && !event.target.closest('.dropdown-toggle')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show-dropdown')) {
                    openDropdown.classList.remove('show-dropdown');
                }
            }
        }
        // Close popups (filter, add, success) if click is on the overlay and allowed
        const popupsToCloseOnClickOutside = ['filterPopup', 'addPropertyPopup', 'actionSuccessPopup'];
        popupsToCloseOnClickOutside.forEach(popupId => {
            const popup = document.getElementById(popupId);
            if (popup && popup.style.display === "flex" && event.target === popup) {
                 if (popup.dataset.backdropClose !== 'false') {
                    // For actionSuccessPopup, use the new function to also refresh
                    if (popupId === 'actionSuccessPopup') {
                        hidePopupAndRefresh(popupId);
                    } else {
                        hidePopup(popupId);
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const propertiesTableBody = document.querySelector('.properties-table tbody');
        if (propertiesTableBody) {
            propertiesTableBody.addEventListener('click', function(event) {
                const row = event.target.closest('tr.clickable-property-row');
                if (row) {
                    currentActionPropertyId = row.dataset.propertyId;
                    currentActionPropertyStatus = row.dataset.propertyStatus;
                    const propertyName = row.dataset.propertyName;

                    document.getElementById('actionConfirmPropertyName').textContent = `"${propertyName}"`;
                    const confirmTitleEl = document.getElementById('actionConfirmTitle');

                    if (currentActionPropertyStatus.toLowerCase() === 'rent') {
                        confirmTitleEl.textContent = 'Rent now?';
                    } else if (currentActionPropertyStatus.toLowerCase() === 'sale') {
                        confirmTitleEl.textContent = 'Buy now?';
                    } else {
                        confirmTitleEl.textContent = 'Process this item?'; // Fallback
                    }
                    showPopup('actionConfirmPopup');
                }
            });
        }

        const actionConfirmNoButton = document.getElementById('actionConfirmNoButton');
        if (actionConfirmNoButton) {
            actionConfirmNoButton.addEventListener('click', function() {
                hidePopup('actionConfirmPopup');
            });
        }

        const actionConfirmYesButton = document.getElementById('actionConfirmYesButton');
        if (actionConfirmYesButton) {
            actionConfirmYesButton.addEventListener('click', function() {
                if (currentActionPropertyId) {
                    actionConfirmYesButton.disabled = true;
                    const noButton = document.getElementById('actionConfirmNoButton');
                    if(noButton) noButton.disabled = true;


                    fetch(`/properties/action/complete/${currentActionPropertyId}`, {
                        method: 'POST',
                        // headers: { 'X-CSRF-TOKEN': 'your_csrf_token_if_needed' }
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || `Server error: ${response.status}`) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        hidePopup('actionConfirmPopup');
                        const rowToRemove = document.querySelector(`.properties-table tbody tr[data-property-id="${currentActionPropertyId}"]`);
                        if (rowToRemove) {
                            rowToRemove.remove(); // Immediate client-side removal
                        }

                        const successMessageEl = document.getElementById('actionSuccessMessage');
                        if (currentActionPropertyStatus.toLowerCase() === 'rent') {
                            successMessageEl.textContent = 'Rent successful!';
                        } else if (currentActionPropertyStatus.toLowerCase() === 'sale') {
                            successMessageEl.textContent = 'Purchase successful!';
                        } else {
                            successMessageEl.textContent = 'Action successful!'; // Fallback
                        }
                        showPopup('actionSuccessPopup');
                        // Note: Page refresh will happen when actionSuccessPopup is closed
                    })
                    .catch(error => {
                        console.error('Error processing property action:', error);
                        alert('Failed to process action: ' + error.message);
                        hidePopup('actionConfirmPopup'); 
                    })
                    .finally(() => {
                        // Re-enable buttons (they are reset inside hidePopup for 'actionConfirmPopup')
                        // currentActionPropertyId and currentActionPropertyStatus are reset in hidePopup
                    });
                }
            });
        }
    });
</script>
</body>
</html>
