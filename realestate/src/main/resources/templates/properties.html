<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Properties</title>
  <link rel="stylesheet" th:href="@{/css/properties.css}" />
</head>
<body>
    <div class="decorative-box">
        <!-- Navigation Bar -->
        <nav>
            <div class="nav-left">
            <div class="logo">
                <span class="logo-circle"></span>
                <a th:href="@{/}" class="company-text-link">
                    <span class="company-text">Spring Real Estate</span>
                </a>
            </div>
            </div>
            <div class="nav-right">
            <ul class="nav-links">
                <li><a th:href="@{/}">Home</a></li>
                <li><a th:href="@{/properties}" class="active-link">Properties</a></li>
                <li><a th:href="@{/about}">About us</a></li>
            </ul>
            </div>
        </nav>
        <!-- Properties content -->
        <div class="page-container">
            <div class="properties-wrapper">
                <div class="properties-header">
                    <h1 th:text="${propertiesMessage}">Properties</h1>
                    <div class="action-buttons">
                        <!-- Sort Dropdown Button -->
                        <div class="dropdown">
                            <button class="action-button sort-button dropdown-toggle" onclick="toggleDropdown('sortDropdownContent')">
                                Sort <span class="dropdown-caret">▾</span>
                            </button>
                            <div id="sortDropdownContent" class="dropdown-content">
                                <a th:href="@{/properties(minPrice=${currentMinPrice != null ? #numbers.formatDecimal(currentMinPrice,1,2,'POINT') : ''}, maxPrice=${currentMaxPrice != null ? #numbers.formatDecimal(currentMaxPrice,1,2,'POINT') : ''}, status=${currentStatus}, sortOrder='price,asc')}"
                                   th:classappend="${currentSortOrder == 'price,asc' ? 'active-sort' : ''}">Price: Low to High</a>
                                <a th:href="@{/properties(minPrice=${currentMinPrice != null ? #numbers.formatDecimal(currentMinPrice,1,2,'POINT') : ''}, maxPrice=${currentMaxPrice != null ? #numbers.formatDecimal(currentMaxPrice,1,2,'POINT') : ''}, status=${currentStatus}, sortOrder='price,desc')}"
                                   th:classappend="${currentSortOrder == 'price,desc' ? 'active-sort' : ''}">Price: High to Low</a>
                            </div>
                        </div>
                        <a class="action-button select-button" onclick="showPopup('filterPopup')">Filter</a>
                        <!-- Filter Popup -->
                        <div id="filterPopup" class="popup">
                            <div class="popup-content">
                                <span class="close-button" onclick="hidePopup('filterPopup')">×</span>
                                <h2>Filter Properties</h2>
                                <form th:action="@{/properties}" method="get" class="filter-form">
                                    <input type="hidden" name="sortOrder" th:value="${currentSortOrder}" /> <!-- Preserve sort order -->
                                    <div class="form-group">
                                        <label for="minPrice">Min Price: <span id="minPriceValue" th:text="${#numbers.formatCurrency(currentMinPrice)}">$0</span></label>
                                        <input type="range" id="minPrice" name="minPrice"
                                               th:min="0"
                                               th:max="${maxOverallPrice}"
                                               th:value="${currentMinPrice}"
                                               step="1000" class="price-slider">
                                    </div>
                                    <div class="form-group">
                                        <label for="maxPrice">Max Price: <span id="maxPriceValue" th:text="${#numbers.formatCurrency(currentMaxPrice)}">$5,000,000</span></label>
                                        <input type="range" id="maxPrice" name="maxPrice"
                                               th:min="0"
                                               th:max="${maxOverallPrice}"
                                               th:value="${currentMaxPrice}"
                                               step="1000" class="price-slider">
                                    </div>
                                    <div class="form-group">
                                        <label>Status:</label>
                                        <div class="status-filter-options">
                                            <div class="status-option">
                                                <input type="radio" id="statusAll" name="status" value="" th:checked="${currentStatus == ''}">
                                                <label for="statusAll">All</label>
                                            </div>
                                            <div class="status-option">
                                                <input type="radio" id="statusForSale" name="status" value="Sale" th:checked="${currentStatus == 'Sale'}">
                                                <label for="statusForSale">Sale</label>
                                            </div>
                                            <div class="status-option">
                                                <input type="radio" id="statusForRent" name="status" value="Rent" th:checked="${currentStatus == 'Rent'}">
                                                <label for="statusForRent">Rent</label>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="action-button apply-filter-button">Apply Filter</button>
                                </form>
                            </div>
                        </div>
                        <a class="action-button add-button" onclick="showPopup('addPropertyPopup')">Add Property</a>
                        <!-- Add Property Popup -->
                        <div id="addPropertyPopup" class="popup">
                            <div class="popup-content">
                                <span class="close-button" onclick="hidePopup('addPropertyPopup')">×</span>
                                <h2>Add New Property</h2>
                                <p>Add Property Form Placeholder</p> <!-- TODO: Implement add form -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="properties-table-container">
                    <table class="properties-table">
                        <thead>
                            <tr>
                                <!-- ID column removed -->
                                <th>Property Name</th>
                                <th>Address</th>
                                <th>Price</th>
                                <th>Type</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${properties.isEmpty()}">
                                <td colspan="5" style="text-align: center;">No properties available for the selected criteria.</td> <!-- colspan changed -->
                            </tr>
                            <tr th:each="property : ${properties}">
                                <!-- ID td removed -->
                                <td th:text="${property.propertyName}">Modern Apartment</td>
                                <td th:text="${property.address}">123 Main St, City</td>
                                <td th:text="${#numbers.formatCurrency(property.price)}">$350,000</td>
                                <td th:text="${property.type}">Apartment</td>
                                <td th:text="${property.status}">Sale</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="bg-image"></div>
        </div>
    </div>
<script th:inline="javascript">
    // JavaScript for popups, price range sliders, and dropdown
    const maxOverallPrice = /*[[${maxOverallPrice}]]*/ 5000000;
    const currentSortOrderJS = /*[[${currentSortOrder}]]*/ 'default';

    function showPopup(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) popup.style.display = "block";
    }
    function hidePopup(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) popup.style.display = "none";
    }

    const minPriceSlider = document.getElementById('minPrice');
    const maxPriceSlider = document.getElementById('maxPrice');
    const minPriceValueDisplay = document.getElementById('minPriceValue');
    const maxPriceValueDisplay = document.getElementById('maxPriceValue');
    const userLocale = document.documentElement.lang || navigator.language || 'en-US';
    const defaultCurrency = 'USD';
    const currencyFormatter = new Intl.NumberFormat(userLocale, {
        style: 'currency', currency: defaultCurrency, minimumFractionDigits: 0, maximumFractionDigits: 0
    });

    function updatePriceDisplay(value, displayElement) {
        if (displayElement) displayElement.textContent = currencyFormatter.format(value);
    }

    if (minPriceSlider && maxPriceSlider && minPriceValueDisplay && maxPriceValueDisplay) {
        updatePriceDisplay(minPriceSlider.value, minPriceValueDisplay);
        updatePriceDisplay(maxPriceSlider.value, maxPriceValueDisplay);
        minPriceSlider.addEventListener('input', function() {
            let minValue = parseFloat(this.value);
            let maxValue = parseFloat(maxPriceSlider.value);
            if (minValue > maxValue) {
                maxPriceSlider.value = minValue;
                updatePriceDisplay(minValue, maxPriceValueDisplay);
            }
            updatePriceDisplay(minValue, minPriceValueDisplay);
        });
        maxPriceSlider.addEventListener('input', function() {
            let maxValue = parseFloat(this.value);
            let minValue = parseFloat(minPriceSlider.value);
            if (maxValue < minValue) {
                minPriceSlider.value = maxValue;
                updatePriceDisplay(maxValue, minPriceValueDisplay);
            }
            updatePriceDisplay(maxValue, maxPriceValueDisplay);
        });
    }

    function toggleDropdown(dropdownId) {
        document.getElementById(dropdownId).classList.toggle("show-dropdown");
    }

    // Close dropdown if the user clicks outside of it
    window.onclick = function(event) {
        if (!event.target.matches('.dropdown-toggle')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show-dropdown')) {
                    openDropdown.classList.remove('show-dropdown');
                }
            }
        }
        // Close popups (filter, add)
        const popups = ['filterPopup', 'addPropertyPopup'];
        popups.forEach(popupId => {
            const popup = document.getElementById(popupId);
            if (popup && popup.style.display === "block") {
                const popupContent = popup.querySelector('.popup-content');
                let isOpeningButton = false;
                if (popupId === 'filterPopup' && event.target.classList.contains('select-button')) {
                    isOpeningButton = true;
                } else if (popupId === 'addPropertyPopup' && event.target.classList.contains('add-button')) {
                    isOpeningButton = true;
                }
                if (popupContent && !popupContent.contains(event.target) && !isOpeningButton && !event.target.closest('.popup-content')) {
                     if (!event.target.matches('.select-button') && !event.target.matches('.add-button')) { // ensure not clicking the open button itself
                        hidePopup(popupId);
                     }
                }
            }
        });
    }
</script>
</body>
</html>
